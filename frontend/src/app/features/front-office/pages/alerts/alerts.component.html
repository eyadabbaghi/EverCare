<div class="min-h-screen bg-gradient-to-br from-[#FAF8FC] to-[#F3E8FF] p-6">
  <div class="max-w-7xl mx-auto space-y-6">
    <!-- Header -->
    <section class="space-y-1">
      <div class="flex items-start justify-between">
        <div>
          <h1 class="text-3xl font-semibold text-[#2D1B4E]">
            {{ isDoctor ? 'Patient Alerts & Incidents' : 'Alerts & Incidents' }}
          </h1>
          <p class="text-sm text-[#6B5B8C]">
            {{
              isDoctor
                ? 'Clinical overview and medical decision support.'
                : isPatient
                ? 'Stay informed about your safety and health.'
                : 'Centralized safety monitoring and alert management.'
            }}
          </p>
        </div>

        <div class="flex items-center gap-3">
          <button
            *ngIf="isPatient"
            type="button"
            class="px-4 py-2 rounded-full bg-[#C06C84] text-white text-sm font-medium shadow hover:bg-[#A85A70]"
          >
            <span class="mr-2">üö®</span>
            Emergency SOS
          </button>
          <!-- Always visible create-incident button -->
          <button
            type="button"
            class="px-4 py-2 rounded-full bg-[#7C3AED] text-white text-sm font-medium shadow hover:bg-[#6D28D9]"
            (click)="onCreateIncidentClick()"
          >
            <span class="mr-2">Ôºã</span>
            Report Incident
          </button>
        </div>
      </div>
    </section>

    <!-- Stats -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div
        class="alert-stat-card border border-[#C06C84] rounded-xl bg-red-50 p-4 flex items-center justify-between"
      >
        <div>
          <p class="text-xs text-[#6B5B8C]">Critical</p>
          <p class="text-2xl font-bold text-[#C06C84]">
            {{ stats.critical }}
          </p>
        </div>
        <span class="text-[#C06C84] text-2xl">üö®</span>
      </div>
      <div
        class="alert-stat-card border border-[#C4B5FD] rounded-xl bg-white p-4 flex items-center justify-between"
      >
        <div>
          <p class="text-xs text-[#6B5B8C]">Active</p>
          <p class="text-2xl font-bold text-[#2D1B4E]">
            {{ stats.active }}
          </p>
        </div>
        <span class="text-[#7C3AED] text-2xl">üîî</span>
      </div>
      <div
        class="alert-stat-card border border-[#C4B5FD] rounded-xl bg-white p-4 flex items-center justify-between"
      >
        <div>
          <p class="text-xs text-[#6B5B8C]">Total</p>
          <p class="text-2xl font-bold text-[#2D1B4E]">
            {{ stats.total }}
          </p>
        </div>
        <span class="text-[#7C3AED] text-2xl">üìä</span>
      </div>
      <div
        class="alert-stat-card border border-[#22c55e] rounded-xl bg-green-50 p-4 flex items-center justify-between"
      >
        <div>
          <p class="text-xs text-[#6B5B8C]">Resolved</p>
          <p class="text-2xl font-bold text-[#22c55e]">
            {{ stats.resolved }}
          </p>
        </div>
        <span class="text-[#22c55e] text-2xl">‚úî</span>
      </div>
    </section>

    <!-- Filters -->
    <section
      class="border border-[#C4B5FD] bg-white rounded-xl p-4 grid grid-cols-1 md:grid-cols-5 gap-4 items-center"
    >
      <div class="md:col-span-2">
        <div class="relative">
          <span class="absolute left-3 top-2.5 text-[#6B5B8C]">üîç</span>
          <input
            type="text"
            class="w-full pl-9 pr-3 py-2 rounded-lg border border-[#E5E7EB] text-sm"
            placeholder="Search incidents or patients..."
            [(ngModel)]="searchQuery"
          />
        </div>
      </div>

      <select
        class="w-full px-3 py-2 rounded-lg border border-[#E5E7EB] text-sm"
        [(ngModel)]="filterSeverity"
      >
        <option value="all">All severities</option>
        <option value="CRITICAL">Critical</option>
        <option value="HIGH">High</option>
        <option value="MEDIUM">Medium</option>
        <option value="LOW">Low</option>
      </select>

      <select
        class="w-full px-3 py-2 rounded-lg border border-[#E5E7EB] text-sm"
        [(ngModel)]="filterType"
      >
        <option value="all">All types</option>
        <option value="Medical">Medical</option>
        <option value="Behavioral">Behavioral</option>
        <option value="Safety">Safety</option>
      </select>

      <select
        class="w-full px-3 py-2 rounded-lg border border-[#E5E7EB] text-sm"
        [(ngModel)]="filterStatus"
      >
        <option value="all">All statuses</option>
        <option value="active">Active</option>
        <option value="acknowledged">Acknowledged</option>
        <option value="resolved">Resolved</option>
      </select>

      <select
        *ngIf="isDoctor"
        class="w-full px-3 py-2 rounded-lg border border-[#E5E7EB] text-sm"
        [(ngModel)]="selectedPatientFilter"
      >
        <option value="all">All patients</option>
        <option value="P-001">John Anderson</option>
        <option value="P-002">Mary Wilson</option>
        <option value="P-003">Robert Chen</option>
        <option value="P-004">Emma Davis</option>
      </select>
    </section>

    <!-- Inline incident form -->
    <section *ngIf="showIncidentForm" class="border border-[#C4B5FD] bg-white rounded-xl p-4">
      <h2 class="text-lg font-semibold text-[#2D1B4E] mb-4">
        {{ editingIncident ? 'Edit Incident' : 'Report New Incident' }}
      </h2>
      <div class="space-y-4">
        <div>
          <label class="text-sm font-medium text-[#374151]">Incident title *</label>
          <input
            type="text"
            class="w-full mt-1 px-3 py-2 rounded-lg border border-[#E5E7EB] text-sm"
            [(ngModel)]="newIncident.title"
          />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-[#374151]">Type *</label>
            <select
              class="w-full mt-1 px-3 py-2 rounded-lg border border-[#E5E7EB] text-sm"
              [(ngModel)]="newIncident.type"
            >
              <option value="Medical">Medical</option>
              <option value="Behavioral">Behavioral</option>
              <option value="Safety">Safety</option>
            </select>
          </div>

          <div>
            <label class="text-sm font-medium text-[#374151]">Severity *</label>
            <select
              class="w-full mt-1 px-3 py-2 rounded-lg border border-[#E5E7EB] text-sm"
              [(ngModel)]="newIncident.severity"
            >
              <option value="LOW">LOW</option>
              <option value="MEDIUM">MEDIUM</option>
              <option value="HIGH">HIGH</option>
              <option value="CRITICAL">CRITICAL</option>
            </select>
          </div>
        </div>

        <div *ngIf="!editingIncident">
          <label class="text-sm font-medium text-[#374151]">Patient *</label>
          <select
            class="w-full mt-1 px-3 py-2 rounded-lg border border-[#E5E7EB] text-sm"
            [(ngModel)]="newIncident.patientId"
          >
            <option value="">Select patient</option>
            <option value="P-001">John Anderson (78 yrs)</option>
            <option value="P-002">Mary Wilson (82 yrs)</option>
            <option value="P-003">Robert Chen (75 yrs)</option>
            <option value="P-004">Emma Davis (80 yrs)</option>
          </select>
        </div>

        <div>
          <label class="text-sm font-medium text-[#374151]">Description *</label>
          <textarea
            rows="3"
            class="w-full mt-1 px-3 py-2 rounded-lg border border-[#E5E7EB] text-sm"
            [(ngModel)]="newIncident.description"
          ></textarea>
        </div>

        <div>
          <label class="text-sm font-medium text-[#374151]">Location</label>
          <input
            type="text"
            class="w-full mt-1 px-3 py-2 rounded-lg border border-[#E5E7EB] text-sm"
            [(ngModel)]="newIncident.location"
          />
        </div>

        <div class="flex justify-end gap-2 pt-2">
          <button
            type="button"
            class="px-4 py-2 rounded-full border border-[#E5E7EB] text-sm text-[#374151]"
            (click)="showIncidentForm = false; editingIncident = null"
          >
            Cancel
          </button>
          <button
            type="button"
            class="px-4 py-2 rounded-full bg-[#7C3AED] text-white text-sm font-medium"
            [disabled]="
              !newIncident.title ||
              !newIncident.description ||
              (!editingIncident && !newIncident.patientId)
            "
            (click)="editingIncident ? saveIncident() : createIncident()"
          >
            {{ editingIncident ? 'Save Incident' : 'Create Incident' }}
          </button>
        </div>
      </div>
    </section>

    <!-- Main layout: incidents (with pagination) + details / alerts -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Incidents list -->
      <div class="lg:col-span-2 space-y-4">
        <ng-container *ngIf="paginatedIncidents.length; else noIncidents">
          <div
            *ngFor="let incident of paginatedIncidents"
            class="alert-row border-2 rounded-2xl bg-white p-5 cursor-pointer hover:shadow-lg transition"
            (click)="selectIncident(incident)"
          >
            <div class="flex items-start gap-4">
              <div
                class="w-12 h-12 rounded-full bg-[#C4B5FD] flex items-center justify-center text-sm font-semibold text-[#7C3AED]"
              >
                {{ getInitials(incident.patientName) }}
              </div>
              <div class="flex-1 min-w-0">
                <h2 class="text-lg font-semibold text-[#2D1B4E] mb-1">
                  {{ incident.title }}
                </h2>
                <p class="text-sm text-[#6B5B8C] mb-2">
                  {{ incident.patientName }}
                </p>
                <div class="flex flex-wrap gap-2 mb-2">
                  <span
                    class="px-3 py-1 rounded-full text-xs font-medium"
                    [ngClass]="getSeverityBadgeClasses(incident.severity)"
                  >
                    {{ incident.severity }}
                  </span>
                  <span
                    class="px-3 py-1 rounded-full text-xs font-medium bg-white border border-[#E5E7EB] text-[#2D1B4E]"
                  >
                    {{ incident.type }}
                  </span>
                  <span
                    *ngIf="getFirstAlert(incident.id) as firstAlert"
                    class="px-3 py-1 rounded-full text-xs font-medium"
                    [ngClass]="getStatusBadgeClasses(firstAlert.status)"
                  >
                    {{ firstAlert.status }}
                  </span>
                </div>
                <div class="flex flex-wrap gap-4 text-xs text-[#6B5B8C]">
                  <div class="flex items-center gap-1">
                    <span>üìç</span>
                    <span>{{ incident.location }}</span>
                  </div>
                  <div class="flex items-center gap-1" *ngIf="getFirstAlert(incident.id) as fa">
                    <span>‚è±</span>
                    <span>Triggered {{ getElapsedMinutes(fa.triggeredAt) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #noIncidents>
          <div class="border border-[#C4B5FD] rounded-2xl bg-white p-8 text-center">
            <p class="text-2xl mb-2">‚úÖ</p>
            <p class="text-lg font-semibold text-[#2D1B4E] mb-1">
              No incidents found
            </p>
            <p class="text-sm text-[#6B5B8C]">
              Adjust filters or create a new incident.
            </p>
          </div>
        </ng-template>

        <!-- Incidents pagination -->
        <div
          *ngIf="filteredIncidents.length > 0"
          class="flex items-center justify-between text-xs text-[#6B5B8C]"
        >
          <span>Page {{ incidentPage }} of {{ totalIncidentPages }}</span>
          <div class="flex gap-2">
            <button
              type="button"
              class="px-3 py-1 rounded-full border border-[#E5E7EB]"
              [disabled]="incidentPage === 1"
              (click)="previousIncidentPage()"
            >
              Previous
            </button>
            <button
              type="button"
              class="px-3 py-1 rounded-full border border-[#E5E7EB]"
              [disabled]="incidentPage === totalIncidentPages"
              (click)="nextIncidentPage()"
            >
              Next
            </button>
          </div>
        </div>
      </div>

      <!-- Details + alerts -->
      <div class="lg:col-span-1 space-y-4">
        <ng-container *ngIf="selectedIncident; else selectPrompt">
          <div class="border border-[#C4B5FD] rounded-2xl bg-white p-5 space-y-4">
            <div class="flex items-start justify-between">
              <div>
                <h2 class="text-lg font-semibold text-[#2D1B4E]">
                  Incident Details
                </h2>
                <p class="text-xs text-[#6B5B8C]">
                  {{ selectedIncident.title }}
                </p>
              </div>
              <button
                type="button"
                class="text-[#6B5B8C] hover:text-[#111827]"
                (click)="selectedIncident = null; selectedAlert = null; showAlertForm = false"
              >
                ‚úï
              </button>
            </div>

            <!-- Patient info -->
            <div class="flex items-center gap-3 p-3 bg-[#F3E8FF] rounded-lg">
              <div
                class="w-10 h-10 rounded-full bg-[#C4B5FD] flex items-center justify-center text-xs font-semibold text-[#7C3AED]"
              >
                {{ getInitials(selectedIncident.patientName || '') }}
              </div>
              <div>
                <p class="font-semibold text-[#2D1B4E]">
                  {{ selectedIncident.patientName }}
                </p>
                <p class="text-xs text-[#6B5B8C]">
                  {{ selectedIncident.patientId }}
                </p>
              </div>
            </div>

            <div class="space-y-2 text-sm">
              <div>
                <label class="text-xs text-[#6B5B8C]">Description</label>
                <p class="text-[#2D1B4E]">
                  {{ selectedIncident.description }}
                </p>
              </div>
              <div class="flex flex-wrap gap-2">
                <span
                  class="px-3 py-1 rounded-full text-xs font-medium"
                  [ngClass]="getSeverityBadgeClasses(selectedIncident.severity || 'LOW')"
                >
                  {{ selectedIncident.severity }}
                </span>
                <span
                  class="px-3 py-1 rounded-full text-xs font-medium bg-white border border-[#E5E7EB] text-[#2D1B4E]"
                >
                  {{ selectedIncident.type }}
                </span>
              </div>
              <div class="flex items-center gap-1 text-xs text-[#6B5B8C]">
                <span>üìç</span>
                <span>{{ selectedIncident.location }}</span>
              </div>
            </div>

            <!-- Incident CRUD & create alert -->
            <div *ngIf="!isPatient" class="space-y-2">
              <button
                type="button"
                class="w-full px-4 py-2 rounded-full bg-[#7C3AED] text-white text-sm font-medium hover:bg-[#6D28D9]"
                (click)="openCreateAlert(selectedIncident!)"
              >
                Ôºã Create Alert
              </button>
              <button
                type="button"
                class="w-full px-4 py-2 rounded-full border border-[#E5E7EB] text-sm text-[#374151]"
                (click)="openEditIncident(selectedIncident!)"
              >
                ‚úé Edit Incident
              </button>
              <button
                type="button"
                class="w-full px-4 py-2 rounded-full border border-[#C06C84] text-sm text-[#C06C84] hover:bg-red-50"
                (click)="deleteIncident(selectedIncident!)"
              >
                üóë Delete Incident
              </button>
            </div>

            <!-- Inline create/edit alert card -->
            <div *ngIf="showAlertForm" class="border border-[#C4B5FD] rounded-xl bg-[#F9FAFF] p-4">
              <h3 class="text-sm font-semibold text-[#2D1B4E] mb-2">
                {{ editingAlert ? 'Edit Alert' : 'Create Alert' }}
              </h3>
              <div class="space-y-3 text-xs">
                <div>
                  <label class="font-medium text-[#374151] mb-1 block">
                    Target roles
                  </label>
                  <div class="space-y-1">
                    <label class="flex items-center gap-2">
                      <input
                        type="checkbox"
                        [checked]="newAlert.targetRoles.includes('Caregiver')"
                        (change)="onTargetRoleToggle('Caregiver', $any($event.target).checked)"
                      />
                      <span>Caregiver</span>
                    </label>
                    <label class="flex items-center gap-2">
                      <input
                        type="checkbox"
                        [checked]="newAlert.targetRoles.includes('Doctor')"
                        (change)="onTargetRoleToggle('Doctor', $any($event.target).checked)"
                      />
                      <span>Doctor</span>
                    </label>
                    <label class="flex items-center gap-2">
                      <input
                        type="checkbox"
                        [checked]="newAlert.targetRoles.includes('Family')"
                        (change)="onTargetRoleToggle('Family', $any($event.target).checked)"
                      />
                      <span>Family</span>
                    </label>
                  </div>
                </div>

                <div>
                  <label class="font-medium text-[#374151] mb-1 block">
                    Notification channels
                  </label>
                  <div class="space-y-1">
                    <label class="flex items-center gap-2">
                      <input
                        type="checkbox"
                        [checked]="newAlert.notificationChannels.includes('in-app')"
                        (change)="onChannelToggle('in-app', $any($event.target).checked)"
                      />
                      <span>In-app</span>
                    </label>
                    <label class="flex items-center gap-2">
                      <input
                        type="checkbox"
                        [checked]="newAlert.notificationChannels.includes('sms')"
                        (change)="onChannelToggle('sms', $any($event.target).checked)"
                      />
                      <span>SMS</span>
                    </label>
                    <label class="flex items-center gap-2">
                      <input
                        type="checkbox"
                        [checked]="newAlert.notificationChannels.includes('email')"
                        (change)="onChannelToggle('email', $any($event.target).checked)"
                      />
                      <span>Email</span>
                    </label>
                  </div>
                </div>

                <div>
                  <label class="font-medium text-[#374151] mb-1 block">
                    Trigger time
                  </label>
                  <input
                    type="time"
                    class="w-full mt-1 px-3 py-2 rounded-lg border border-[#E5E7EB] text-sm"
                    [(ngModel)]="newAlert.triggerTime"
                  />
                  <p class="mt-1 text-[10px] text-[#6B5B8C]">
                    Works like an alarm clock: the alert will trigger at the next occurrence of this
                    time.
                  </p>
                </div>

                <div class="flex justify-end gap-2 pt-2">
                  <button
                    type="button"
                    class="px-3 py-1 rounded-full border border-[#E5E7EB]"
                    (click)="showAlertForm = false; editingAlert = null"
                  >
                    Cancel
                  </button>
                  <button
                    type="button"
                    class="px-3 py-1 rounded-full bg-[#7C3AED] text-white"
                    [disabled]="
                      !newAlert.targetRoles.length ||
                      !newAlert.notificationChannels.length ||
                      !newAlert.triggerTime
                    "
                    (click)="saveAlert()"
                  >
                    {{ editingAlert ? 'Save Alert' : 'Create Alert' }}
                  </button>
                </div>
              </div>
            </div>

            <!-- Alerts list for this incident + pagination -->
            <div *ngIf="alertsForSelectedIncident.length" class="space-y-2">
              <h3 class="text-xs font-semibold text-[#6B5B8C]">
                Alerts for this incident
              </h3>
              <div
                *ngFor="let alert of paginatedAlerts"
                class="flex items-center justify-between rounded-md border border-[#E5E7EB] bg-[#F9FAFB] px-3 py-2 text-xs"
              >
                <div>
                  <p class="font-semibold text-[#2D1B4E]">
                    {{ alert.id }} ‚Äì {{ alert.status }}
                  </p>
                  <p class="text-[#6B5B8C]">
                    Channels:
                    {{ alert.notificationChannels.length ? alert.notificationChannels.join(', ') : '‚Äî' }}
                  </p>
                </div>
                <div class="flex gap-2">
                  <button
                    type="button"
                    class="px-2 py-1 rounded-full border border-[#E5E7EB]"
                    (click)="openEditAlert(alert)"
                  >
                    Edit
                  </button>
                  <button
                    type="button"
                    class="px-2 py-1 rounded-full border border-[#C06C84] text-[#C06C84]"
                    (click)="deleteAlert(alert)"
                  >
                    Delete
                  </button>
                </div>
              </div>

              <div
                *ngIf="alertsForSelectedIncident.length > ALERTS_PER_PAGE"
                class="flex items-center justify-between text-[10px] text-[#6B5B8C]"
              >
                <span>Page {{ alertsPage }} of {{ totalAlertPages }}</span>
                <div class="flex gap-1">
                  <button
                    type="button"
                    class="px-2 py-1 rounded-full border border-[#E5E7EB]"
                    [disabled]="alertsPage === 1"
                    (click)="previousAlertsPage()"
                  >
                    Prev
                  </button>
                  <button
                    type="button"
                    class="px-2 py-1 rounded-full border border-[#E5E7EB]"
                    [disabled]="alertsPage === totalAlertPages"
                    (click)="nextAlertsPage()"
                  >
                    Next
                  </button>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #selectPrompt>
          <div class="border border-[#C4B5FD] rounded-2xl bg-white p-6 text-sm text-[#6B5B8C]">
            Select an incident on the left to view details, edit it, and manage alerts.
          </div>
        </ng-template>
      </div>
    </section>
  </div>
</div>

