<div class="min-h-screen bg-gradient-to-br from-[#FAF8FC] to-[#F3E8FF] p-4 md:p-8">
  <div class="max-w-5xl mx-auto space-y-6">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-[#2D1B4E] mb-2">
        Profile Settings
      </h1>
      <p class="text-[#6B5B8C]">
        Manage your personal information and preferences
      </p>
    </div>

    <!-- Profile card - only show if user exists -->
    <div *ngIf="user" class="profile-card border border-[#C4B5FD] rounded-2xl bg-white">
      <div class="p-6 flex flex-col md:flex-row items-center md:items-start gap-6">
        <!-- Avatar with dropdown -->
        <div class="relative">
          <div class="w-32 h-32 rounded-full bg-[#C4B5FD] flex items-center justify-center text-3xl text-[#7C3AED] overflow-hidden">
            <ng-container *ngIf="user?.profilePicture; else initials">
              <img [src]="user?.profilePicture" alt="Profile" class="w-full h-full object-cover">
            </ng-container>
            <ng-template #initials>
              <span>{{ getInitials(user?.name) }}</span>
            </ng-template>
          </div>

          <!-- Camera icon with dropdown -->
          <div class="absolute bottom-0 right-0">
            <button
              type="button"
              class="w-9 h-9 rounded-full bg-[#7C3AED] text-white flex items-center justify-center shadow-lg hover:bg-[#6D28D9]"
              (click)="togglePictureMenu()"
              [disabled]="isLoading"
            >
              üì∑
            </button>

            <!-- Dropdown menu -->
            <div *ngIf="showPictureMenu" class="absolute right-0 bottom-full mb-2 w-48 bg-white border border-[#E5E7EB] rounded-xl shadow-lg overflow-hidden z-50">
              <button
                type="button"
                class="w-full text-left px-4 py-2.5 text-sm text-[#2D1B4E] hover:bg-[#F3E8FF] flex items-center"
                (click)="triggerFileInput()"
              >
                <span class="mr-2">üì∑</span>
                Upload Picture
              </button>
              <button
                *ngIf="user?.profilePicture"
                type="button"
                class="w-full text-left px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 flex items-center"
                (click)="removePicture()"
              >
                <span class="mr-2">üóëÔ∏è</span>
                Remove Picture
              </button>
            </div>
          </div>

          <!-- Hidden file input -->
          <input
            type="file"
            id="profile-picture-input"
            accept="image/*"
            class="hidden"
            (change)="onFileSelected($event)"
          />
        </div>

        <div class="flex-1 text-center md:text-left space-y-2">
          <h2 class="text-2xl font-bold text-[#2D1B4E]">
            {{ user.name }}
          </h2>
          <p class="text-[#6B5B8C]">
            {{ user.email }}
          </p>
          <div class="flex flex-wrap gap-2 justify-center md:justify-start mt-3">
            <span class="inline-flex items-center px-3 py-1 rounded-full bg-[#7C3AED] text-xs font-medium text-white capitalize">
              {{ user.role }}
            </span>
            <span class="inline-flex items-center px-3 py-1 rounded-full border border-[#C4B5FD] text-xs text-[#2D1B4E] bg-[#F9FAFB]">
              <span class="mr-1">üõ°Ô∏è</span>
              Verified account
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="w-full">
      <div class="grid grid-cols-3 gap-2 mb-6 bg-white rounded-full p-1 border border-[#E5E7EB]">
        <button
          type="button"
          class="px-4 py-2 rounded-full text-sm font-medium"
          [ngClass]="
            activeTab === 'personal'
              ? 'bg-[#7C3AED] text-white shadow-sm'
              : 'text-[#6B5B8C] hover:text-[#4B5563]'
          "
          (click)="setTab('personal')"
        >
          Personal Info
        </button>
        <button
          type="button"
          class="px-4 py-2 rounded-full text-sm font-medium"
          [ngClass]="
            activeTab === 'health'
              ? 'bg-[#7C3AED] text-white shadow-sm'
              : 'text-[#6B5B8C] hover:text-[#4B5563]'
          "
          (click)="setTab('health')"
        >
          Health Info
        </button>
        <button
          type="button"
          class="px-4 py-2 rounded-full text-sm font-medium"
          [ngClass]="
            activeTab === 'settings'
              ? 'bg-[#7C3AED] text-white shadow-sm'
              : 'text-[#6B5B8C] hover:text-[#4B5563]'
          "
          (click)="setTab('settings')"
        >
          Settings
        </button>
      </div>

      <!-- Personal information tab (now with reactive form) -->
      <div
        *ngIf="activeTab === 'personal'"
        class="profile-section-card border border-[#C4B5FD] rounded-2xl bg-white"
      >
        <form [formGroup]="personalForm">
          <div class="border-b border-[#E5E7EB] px-6 py-4 flex items-center justify-between">
            <div>
              <h3 class="text-base font-semibold text-[#2D1B4E]">
                Personal information
              </h3>
              <p class="text-sm text-[#6B5B8C]">
                Update your personal details
              </p>
            </div>
            <button
              type="button"
              class="px-4 py-2 rounded-full bg-[#7C3AED] text-sm text-white font-medium hover:bg-[#6D28D9]"
              (click)="toggleEdit()"
            >
              {{ isEditing ? 'Save changes' : 'Edit profile' }}
            </button>
          </div>

          <div class="p-6 space-y-4">
            <div class="grid md:grid-cols-2 gap-4">
              <!-- Name -->
              <div class="space-y-2">
                <label class="text-sm font-medium text-[#374151]" for="name">
                  Full name <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                  <span class="absolute left-3 top-2.5 text-[#6B5B8C]">üë§</span>
                  <input
                    id="name"
                    type="text"
                    formControlName="name"
                    class="w-full pl-9 pr-3 py-2 rounded-lg border border-[#E5E7EB] text-sm focus:outline-none focus:ring-2 focus:ring-[#7C3AED]"
                    [class.border-red-500]="isInvalid('name')"
                    [disabled]="!isEditing"
                  />
                </div>
                <div *ngIf="isInvalid('name')" class="text-red-500 text-xs">
                  Name is required.
                </div>
              </div>

              <!-- Email -->
              <div class="space-y-2">
                <label class="text-sm font-medium text-[#374151]" for="email">
                  Email address <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                  <span class="absolute left-3 top-2.5 text-[#6B5B8C]">‚úâÔ∏è</span>
                  <input
                    id="email"
                    type="email"
                    formControlName="email"
                    class="w-full pl-9 pr-3 py-2 rounded-lg border border-[#E5E7EB] text-sm focus:outline-none focus:ring-2 focus:ring-[#7C3AED]"
                    [class.border-red-500]="isInvalid('email')"
                    [disabled]="!isEditing"
                  />
                </div>
                <div *ngIf="isInvalid('email')" class="text-red-500 text-xs">
                  <span *ngIf="personalForm.get('email')?.errors?.['required']">Email is required.</span>
                  <span *ngIf="personalForm.get('email')?.errors?.['email']">Please enter a valid email address.</span>
                </div>
              </div>

              <!-- Phone with country code -->
              <div class="space-y-2">
                <label class="text-sm font-medium text-[#374151]" for="phone">
                  Phone number <span class="text-red-500">*</span>
                </label>
                <div class="flex space-x-2">
                  <select
                    [(ngModel)]="phoneCountryCode"
                    [ngModelOptions]="{standalone: true}"
                    class="w-24 px-2 py-2 rounded-lg border border-[#E5E7EB] text-sm focus:outline-none focus:ring-2 focus:ring-[#7C3AED] bg-white"
                    [disabled]="!isEditing"
                  >
                    <option *ngFor="let c of countries" [value]="c.code">
                      {{ c.flag }} {{ c.code }}
                    </option>
                  </select>
                  <input
                    id="phone"
                    type="tel"
                    formControlName="phone"
                    class="flex-1 pl-3 pr-3 py-2 rounded-lg border border-[#E5E7EB] text-sm focus:outline-none focus:ring-2 focus:ring-[#7C3AED]"
                    [class.border-red-500]="isInvalid('phone')"
                    [disabled]="!isEditing"
                    placeholder="123456789"
                  />
                </div>
                <div *ngIf="isInvalid('phone')" class="text-red-500 text-xs">
                  <span *ngIf="personalForm.get('phone')?.errors?.['required']">Phone number is required.</span>
                  <span *ngIf="personalForm.get('phone')?.errors?.['invalidPhone']">Phone number can only contain digits, spaces, +, -, and parentheses.</span>
                </div>
              </div>

              <!-- Date of birth -->
              <div class="space-y-2">
                <label class="text-sm font-medium text-[#374151]" for="dob">
                  Date of birth <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                  <span class="absolute left-3 top-2.5 text-[#6B5B8C]">üìÖ</span>
                  <input
                    id="dob"
                    type="date"
                    formControlName="dateOfBirth"
                    class="w-full pl-9 pr-3 py-2 rounded-lg border border-[#E5E7EB] text-sm focus:outline-none focus:ring-2 focus:ring-[#7C3AED]"
                    [class.border-red-500]="isInvalid('dateOfBirth')"
                    [disabled]="!isEditing"
                  />
                </div>
                <div *ngIf="isInvalid('dateOfBirth')" class="text-red-500 text-xs">
                  <span *ngIf="personalForm.get('dateOfBirth')?.errors?.['required']">Date of birth is required.</span>
                  <span *ngIf="personalForm.get('dateOfBirth')?.errors?.['futureDate']">Date must be in the past.</span>
                </div>
              </div>
            </div>

            <!-- Address -->
            <div class="space-y-2">
              <label class="text-sm font-medium text-[#374151]" for="address">
                Address
              </label>
              <div class="relative">
                <span class="absolute left-3 top-2.5 text-[#6B5B8C]">üìç</span>
                <input
                  id="address"
                  type="text"
                  formControlName="address"
                  class="w-full pl-9 pr-3 py-2 rounded-lg border border-[#E5E7EB] text-sm focus:outline-none focus:ring-2 focus:ring-[#7C3AED]"
                  [disabled]="!isEditing"
                />
              </div>
            </div>

            <!-- Emergency contact with country code -->
            <div class="space-y-2">
              <label class="text-sm font-medium text-[#374151]" for="emergency">
                Emergency contact <span class="text-red-500">*</span>
              </label>
              <div class="flex space-x-2">
                <select
                  [(ngModel)]="emergencyCountryCode"
                  [ngModelOptions]="{standalone: true}"
                  class="w-24 px-2 py-2 rounded-lg border border-[#E5E7EB] text-sm focus:outline-none focus:ring-2 focus:ring-[#7C3AED] bg-white"
                  [disabled]="!isEditing"
                >
                  <option *ngFor="let c of countries" [value]="c.code">
                    {{ c.flag }} {{ c.code }}
                  </option>
                </select>
                <input
                  id="emergency"
                  type="tel"
                  formControlName="emergencyContact"
                  class="flex-1 pl-3 pr-3 py-2 rounded-lg border border-[#E5E7EB] text-sm focus:outline-none focus:ring-2 focus:ring-[#7C3AED]"
                  [class.border-red-500]="isInvalid('emergencyContact')"
                  [disabled]="!isEditing"
                  placeholder="123456789"
                />
              </div>
              <div *ngIf="isInvalid('emergencyContact')" class="text-red-500 text-xs">
                <span *ngIf="personalForm.get('emergencyContact')?.errors?.['required']">Emergency contact is required.</span>
                <span *ngIf="personalForm.get('emergencyContact')?.errors?.['invalidPhone']">Phone number can only contain digits, spaces, +, -, and parentheses.</span>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Health information tab -->
      <div
        *ngIf="activeTab === 'health'"
        class="profile-section-card border border-[#C4B5FD] rounded-2xl bg-white"
      >
        <div class="border-b border-[#E5E7EB] px-6 py-4">
          <h3 class="text-base font-semibold text-[#2D1B4E]">
            Health information
          </h3>
          <p class="text-sm text-[#6B5B8C]">
            Medical history and health details
          </p>
        </div>

        <div class="p-6 space-y-4">
          <div class="grid md:grid-cols-2 gap-4">
            <div class="space-y-2">
              <label class="text-sm font-medium text-[#374151]" for="blood-type">
                Blood type
              </label>
              <select
                id="blood-type"
                class="w-full px-3 py-2 rounded-lg border border-[#E5E7EB] text-sm focus:outline-none focus:ring-2 focus:ring-[#7C3AED]"
                [disabled]="!isEditing"
                [(ngModel)]="profileData.bloodType"
              >
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
              </select>
            </div>

            <div class="space-y-2">
              <label class="text-sm font-medium text-[#374151]" for="allergies">
                Known allergies
              </label>
              <input
                id="allergies"
                type="text"
                class="w-full px-3 py-2 rounded-lg border border-[#E5E7EB] text-sm focus:outline-none focus:ring-2 focus:ring-[#7C3AED]"
                [disabled]="!isEditing"
                [(ngModel)]="profileData.allergies"
                placeholder="e.g., Penicillin, Peanuts"
              />
            </div>
          </div>

          <div class="bg-[#F3E8FF] border border-[#C4B5FD] rounded-lg p-4">
            <h4 class="font-semibold text-[#2D1B4E] mb-2">
              Medical conditions
            </h4>
            <div class="flex flex-wrap gap-2 text-xs">
              <span class="inline-flex px-3 py-1 rounded-full bg-[#7C3AED] text-white">
                Alzheimer's disease
              </span>
              <span class="inline-flex px-3 py-1 rounded-full bg-[#A78BFA] text-white">
                Hypertension
              </span>
              <span class="inline-flex px-3 py-1 rounded-full bg-[#C4B5FD] text-[#2D1B4E]">
                Arthritis
              </span>
            </div>
          </div>

          <div class="bg-[#F9FAFB] border border-[#E5E7EB] rounded-lg p-4 text-sm text-[#6B5B8C] space-y-2">
            <h4 class="font-semibold text-[#2D1B4E] mb-1">
              Primary care team
            </h4>
            <div class="flex justify-between">
              <span>Primary physician:</span>
              <span class="text-[#2D1B4E] font-medium">Dr. Sarah Wilson</span>
            </div>
            <div class="flex justify-between">
              <span>Neurologist:</span>
              <span class="text-[#2D1B4E] font-medium">Dr. Michael Chen</span>
            </div>
            <div class="flex justify-between">
              <span>Primary caregiver:</span>
              <span class="text-[#2D1B4E] font-medium">Mary Johnson</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings tab -->
      <div
        *ngIf="activeTab === 'settings'"
        class="space-y-4"
      >
        <div class="profile-section-card border border-[#C4B5FD] rounded-2xl bg-white">
          <div class="border-b border-[#E5E7EB] px-6 py-4">
            <h3 class="text-base font-semibold text-[#2D1B4E] flex items-center space-x-2">
              <span>üîî</span>
              <span>Notification preferences</span>
            </h3>
            <p class="text-sm text-[#6B5B8C]">
              Manage how you receive alerts and updates
            </p>
          </div>
          <div class="p-6 space-y-4">
            <div class="profile-setting-item flex items-center justify-between p-4 bg-[#F9FAFB] rounded-lg">
              <div>
                <h4 class="font-medium text-[#2D1B4E]">Email notifications</h4>
                <p class="text-sm text-[#6B5B8C]">
                  Receive updates via email
                </p>
              </div>
              <button
                type="button"
                class="px-3 py-1.5 rounded-full border border-[#C4B5FD] text-xs text-[#2D1B4E]"
              >
                Enabled
              </button>
            </div>

            <div class="profile-setting-item flex items-center justify-between p-4 bg-[#F9FAFB] rounded-lg">
              <div>
                <h4 class="font-medium text-[#2D1B4E]">SMS alerts</h4>
                <p class="text-sm text-[#6B5B8C]">
                  Critical alerts via text message
                </p>
              </div>
              <button
                type="button"
                class="px-3 py-1.5 rounded-full border border-[#C4B5FD] text-xs text-[#2D1B4E]"
              >
                Enabled
              </button>
            </div>

            <div class="profile-setting-item flex items-center justify-between p-4 bg-[#F9FAFB] rounded-lg">
              <div>
                <h4 class="font-medium text-[#2D1B4E]">Appointment reminders</h4>
                <p class="text-sm text-[#6B5B8C]">
                  Get reminded before appointments
                </p>
              </div>
              <button
                type="button"
                class="px-3 py-1.5 rounded-full border border-[#C4B5FD] text-xs text-[#2D1B4E]"
              >
                Enabled
              </button>
            </div>

            <div class="flex items-center justify-between p-4 bg-[#F9FAFB] rounded-lg">
              <div>
                <h4 class="font-medium text-[#2D1B4E]">Medication reminders</h4>
                <p class="text-sm text-[#6B5B8C]">
                  Daily medication notifications
                </p>
              </div>
              <button
                type="button"
                class="px-3 py-1.5 rounded-full border border-[#C4B5FD] text-xs text-[#2D1B4E]"
              >
                Enabled
              </button>
            </div>
          </div>
        </div>

        <div class="profile-section-card border border-[#C4B5FD] rounded-2xl bg-white">
          <div class="border-b border-[#E5E7EB] px-6 py-4">
            <h3 class="text-base font-semibold text-[#2D1B4E] flex items-center space-x-2">
              <span>üîí</span>
              <span>Security</span>
            </h3>
            <p class="text-sm text-[#6B5B8C]">
              Manage your account security
            </p>
          </div>
          <div class="p-6 space-y-4">
            <!-- Change password button -->
            <div class="profile-setting-item flex items-center justify-between p-4 bg-[#F9FAFB] rounded-lg">
              <div>
                <h4 class="font-medium text-[#2D1B4E]">Change password</h4>
                <p class="text-sm text-[#6B5B8C]">
                  Update your account password
                </p>
              </div>
              <button
                type="button"
                class="px-3 py-1.5 rounded-full border border-[#C4B5FD] text-xs text-[#2D1B4E] hover:bg-[#F3E8FF]"
                (click)="toggleChangePassword()"
                [disabled]="isLoading"
              >
                {{ isChangingPassword ? 'Cancel' : 'Change' }}
              </button>
            </div>

            <!-- Password change form (conditionally shown) -->
            <div *ngIf="isChangingPassword" class="p-4 bg-white border border-[#E5E7EB] rounded-lg space-y-3">
              <div>
                <label class="block text-xs font-medium text-[#374151] mb-1">Current Password</label>
                <input
                  type="password"
                  class="w-full px-3 py-2 rounded-lg border border-[#E5E7EB] text-sm focus:outline-none focus:ring-2 focus:ring-[#7C3AED]"
                  [(ngModel)]="passwordData.currentPassword"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                />
              </div>
              <div>
                <label class="block text-xs font-medium text-[#374151] mb-1">New Password</label>
                <input
                  type="password"
                  class="w-full px-3 py-2 rounded-lg border border-[#E5E7EB] text-sm focus:outline-none focus:ring-2 focus:ring-[#7C3AED]"
                  [(ngModel)]="passwordData.newPassword"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                />
                <p class="text-xs text-[#6B5B8C] mt-1">
                  Must be at least 8 chars, include uppercase, digit, and special character.
                </p>
              </div>
              <button
                type="button"
                class="w-full bg-[#7C3AED] hover:bg-[#6D28D9] text-white text-sm font-medium py-2 rounded-lg"
                (click)="handleChangePassword()"
                [disabled]="isLoading"
              >
                {{ isLoading ? 'Updating...' : 'Update Password' }}
              </button>
            </div>

            <!-- Two-factor authentication (placeholder) -->
            <div class="profile-setting-item flex items-center justify-between p-4 bg-[#F9FAFB] rounded-lg">
              <div>
                <h4 class="font-medium text-[#2D1B4E]">Two-factor authentication</h4>
                <p class="text-sm text-[#6B5B8C]">
                  Add extra security to your account
                </p>
              </div>
              <button
                type="button"
                class="px-3 py-1.5 rounded-full border border-[#C4B5FD] text-xs text-[#2D1B4E]"
                disabled
              >
                Enable
              </button>
            </div>

            <!-- Active sessions (placeholder) -->
            <div class="profile-setting-item flex items-center justify-between p-4 bg-[#F9FAFB] rounded-lg">
              <div>
                <h4 class="font-medium text-[#2D1B4E]">Active sessions</h4>
                <p class="text-sm text-[#6B5B8C]">
                  Manage logged-in devices
                </p>
              </div>
              <button
                type="button"
                class="px-3 py-1.5 rounded-full border border-[#C4B5FD] text-xs text-[#2D1B4E]"
                disabled
              >
                View
              </button>
            </div>
          </div>
        </div>

        <!-- Danger zone -->
        <div class="profile-section-card border border-red-200 rounded-2xl bg-white">
          <div class="border-b border-red-200 px-6 py-4">
            <h3 class="text-base font-semibold text-red-600 flex items-center space-x-2">
              <span>‚ö†Ô∏è</span>
              <span>Danger Zone</span>
            </h3>
            <p class="text-sm text-[#6B5B8C]">
              Irreversible actions for your account
            </p>
          </div>
          <div class="p-6">
            <div class="flex items-center justify-between p-4 bg-red-50 rounded-lg">
              <div>
                <h4 class="font-medium text-red-700">Delete account</h4>
                <p class="text-sm text-red-600">
                  Permanently delete your account and all associated data
                </p>
              </div>
              <button
                type="button"
                class="px-4 py-2 rounded-full bg-red-600 text-white text-sm font-medium hover:bg-red-700"
                (click)="confirmDeleteAccount()"
                [disabled]="isLoading"
              >
                {{ isLoading ? 'Deleting...' : 'Delete' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>